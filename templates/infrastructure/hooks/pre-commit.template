#!/bin/bash

# ═══════════════════════════════════════════════════════════════════════════════
# PRE-COMMIT HOOK: {{PROJECT_NAME}}
#
# Ensures documentation stays in sync with code.
# Blocks commits that break promises or have stale docs.
#
# To bypass (emergency only): git commit --no-verify
# ═══════════════════════════════════════════════════════════════════════════════

set -e

PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "                    PRE-COMMIT VERIFICATION                        "
echo "═══════════════════════════════════════════════════════════════════"
echo ""

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

if [ -z "$STAGED_FILES" ]; then
    echo "No files staged. Nothing to verify."
    exit 0
fi

# Track what changed
CODE_CHANGED=""
DOCS_CHANGED=""
TESTS_CHANGED=""
CLAUDE_MD_CHANGED=""

for file in $STAGED_FILES; do
    case "$file" in
        src/*|api/*|web/*|app/*|lib/*)
            CODE_CHANGED="$CODE_CHANGED $file"
            ;;
        docs/*|*.md)
            DOCS_CHANGED="$DOCS_CHANGED $file"
            ;;
        tests/*|test/*|__tests__/*|*.test.*|*.spec.*)
            TESTS_CHANGED="$TESTS_CHANGED $file"
            ;;
    esac

    [ "$file" = "CLAUDE.md" ] && CLAUDE_MD_CHANGED="yes"
done

ERRORS=0
WARNINGS=0

# ═══════════════════════════════════════════════════════════════════════════════
# CHECK 1: Code changed → CLAUDE.md should update
# ═══════════════════════════════════════════════════════════════════════════════

if [ -n "$CODE_CHANGED" ]; then
    echo -e "${YELLOW}Code changes detected:${NC}"
    for f in $CODE_CHANGED; do
        echo "  • $f"
    done | head -10
    [ $(echo "$CODE_CHANGED" | wc -w) -gt 10 ] && echo "  ... and more"
    echo ""

    if [ -z "$CLAUDE_MD_CHANGED" ]; then
        echo -e "${YELLOW}⚠ WARNING: Code changed but CLAUDE.md not updated${NC}"
        echo "   Consider updating the 'Current State' section."
        echo ""
        ((WARNINGS++))
    fi
fi

# ═══════════════════════════════════════════════════════════════════════════════
# CHECK 2: Significant code changes → Tests should exist
# ═══════════════════════════════════════════════════════════════════════════════

# Count new source files
NEW_SOURCE_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E "^src/|^api/|^web/" | grep -v "\.test\.\|\.spec\." || true)

if [ -n "$NEW_SOURCE_FILES" ]; then
    echo -e "${BLUE}New source files:${NC}"
    for f in $NEW_SOURCE_FILES; do
        echo "  • $f"

        # Check if corresponding test exists (in staged files)
        BASE_NAME=$(basename "$f" | sed 's/\.[^.]*$//')
        if ! echo "$STAGED_FILES" | grep -q "$BASE_NAME.*test\|$BASE_NAME.*spec"; then
            echo -e "    ${YELLOW}⚠ No test file staged for this${NC}"
            ((WARNINGS++))
        fi
    done
    echo ""
fi

# ═══════════════════════════════════════════════════════════════════════════════
# CHECK 3: Run project verification
# ═══════════════════════════════════════════════════════════════════════════════

VERIFY_SCRIPT="$PROJECT_ROOT/scripts/verify-project.sh"

if [ -f "$VERIFY_SCRIPT" ] && [ -x "$VERIFY_SCRIPT" ]; then
    echo "Running project verification..."
    echo ""

    if ! "$VERIFY_SCRIPT" -q; then
        echo ""
        echo -e "${RED}❌ Project verification failed${NC}"
        echo "   Run: ./scripts/verify-project.sh -v"
        echo "   for detailed output."
        echo ""
        ((ERRORS++))
    else
        echo -e "${GREEN}✓ Project verification passed${NC}"
        echo ""
    fi
else
    echo -e "${YELLOW}⚠ Verification script not found or not executable${NC}"
    echo "   Expected: $VERIFY_SCRIPT"
    echo ""
fi

# ═══════════════════════════════════════════════════════════════════════════════
# CHECK 4: Run tests (optional, configured via {{RUN_TESTS_ON_COMMIT}})
# ═══════════════════════════════════════════════════════════════════════════════

RUN_TESTS_ON_COMMIT={{RUN_TESTS_ON_COMMIT}}  # true or false

# Only run if code changed and tests configured to run
if [ "$RUN_TESTS_ON_COMMIT" = "true" ] && [ -n "$CODE_CHANGED" ]; then
    if [ -f "$PROJECT_ROOT/package.json" ] && grep -q '"test"' "$PROJECT_ROOT/package.json"; then
        echo "Running tests..."
        echo ""

        # Run tests but don't block on failure (just warn)
        if ! npm test --silent 2>&1 | head -20; then
            echo ""
            echo -e "${YELLOW}⚠ Some tests failed${NC}"
            echo "   Consider fixing before committing."
            echo ""
            ((WARNINGS++))
        else
            echo -e "${GREEN}✓ Tests passed${NC}"
            echo ""
        fi
    fi
fi

# ═══════════════════════════════════════════════════════════════════════════════
# VERDICT
# ═══════════════════════════════════════════════════════════════════════════════

echo "═══════════════════════════════════════════════════════════════════"
echo "                         VERDICT                                   "
echo "═══════════════════════════════════════════════════════════════════"
echo ""

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}${BOLD}❌ COMMIT BLOCKED${NC}"
    echo ""
    echo "   $ERRORS error(s) must be fixed."
    echo ""
    echo "   Fix the issues above and try again."
    echo -e "   ${YELLOW}Emergency bypass: git commit --no-verify${NC}"
    echo ""
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}${BOLD}⚠ COMMIT ALLOWED WITH $WARNINGS WARNING(S)${NC}"
    echo ""
    echo "   Consider addressing the warnings above."
    echo ""
    exit 0
else
    echo -e "${GREEN}${BOLD}✓ COMMIT APPROVED${NC}"
    echo ""
    exit 0
fi
