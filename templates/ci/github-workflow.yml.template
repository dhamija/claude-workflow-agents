name: Validate Against Intent/UX/Architecture

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Validation Suite
        id: validate
        run: |
          chmod +x ci/validate.sh
          CI_TRIGGER="github-actions" ./ci/validate.sh
        continue-on-error: true

      - name: Read Validation Report
        id: report
        run: |
          if [ -f ci/reports/latest.md ]; then
            echo "REPORT<<EOF" >> $GITHUB_OUTPUT
            cat ci/reports/latest.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "REPORT=Validation report not found" >> $GITHUB_OUTPUT
          fi

      - name: Post Report to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const report = `${{ steps.report.outputs.REPORT }}`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Validation Report')
            );

            const body = `## üîç Validation Report\n\n${report}\n\n---\n*Generated by ci-cd-engineer | [Learn More](../docs/intent)*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check for Critical Violations
        run: |
          if [ -f ci/reports/latest.md ] && grep -q "CRITICAL.*FAIL" ci/reports/latest.md; then
            echo "‚ùå Critical violations found - blocking merge"
            echo ""
            echo "The following promises from /docs/intent/ are broken:"
            grep "CRITICAL.*FAIL" ci/reports/latest.md || true
            echo ""
            echo "Fix these violations before merging."
            exit 1
          fi

      - name: Upload Report Artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: validation-report
          path: ci/reports/latest.md
