#!/bin/bash

# Test Validator
# Checks test coverage for user journeys and critical features

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
RULES_FILE="$SCRIPT_DIR/rules.json"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo ""
echo "## Test Coverage Validation"
echo ""

# Check if rules exist
if [ ! -f "$RULES_FILE" ]; then
    echo "❌ ERROR: Rules file not found: $RULES_FILE"
    exit 1
fi

VIOLATIONS=()
PASSES=()

# Load rules using jq
if ! command -v jq &> /dev/null; then
    echo "⚠️  WARNING: jq not installed - install with: brew install jq"
    echo "Skipping automated checks"
    exit 0
fi

# Count test files
count_tests() {
    local test_count=0

    # Find all test files
    test_count=$(find "$PROJECT_ROOT" -type f \( -name "*.test.*" -o -name "*.spec.*" -o -name "*_test.*" -o -path "*/tests/*" -o -path "*/__tests__/*" \) 2>/dev/null | wc -l | tr -d ' ')

    echo "**Test Files Found:** $test_count"
    echo ""

    if [ "$test_count" -eq 0 ]; then
        VIOLATIONS+=("[CRITICAL] No test files found in project")
    else
        PASSES+=("✅ Test infrastructure exists ($test_count files)")
    fi
}

# Check that critical journeys have tests
check_journey_coverage() {
    local journey_count=$(jq -r '.journeys | length' "$RULES_FILE")

    if [ "$journey_count" -eq 0 ] || [ "$journey_count" = "null" ]; then
        echo "**No user journeys defined** - skipping journey coverage check"
        echo ""
        return
    fi

    echo "**Journey Coverage:**"
    echo ""

    local tested=0
    local untested=0

    for ((i=0; i<$journey_count; i++)); do
        local name=$(jq -r ".journeys[$i].name" "$RULES_FILE")
        local severity=$(jq -r ".journeys[$i].severity // \"HIGH\"" "$RULES_FILE")

        # Convert journey name to test search pattern
        local pattern=$(echo "$name" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

        # Search for test
        if find "$PROJECT_ROOT" -type f \( -name "*test*" -o -name "*spec*" \) -exec grep -l "$pattern\|$name" {} \; 2>/dev/null | grep -q .; then
            echo "- ✅ $name (tested)"
            ((tested++))
        else
            echo "- ❌ $name (NOT TESTED)"
            VIOLATIONS+=("[$severity] Journey not tested: $name")
            ((untested++))
        fi
    done

    echo ""
    echo "**Coverage:** $tested/$journey_count journeys tested"
    echo ""

    if [ $tested -eq $journey_count ]; then
        PASSES+=("✅ All journeys have tests ($tested/$journey_count)")
    fi
}

# Check for E2E tests
check_e2e_tests() {
    # Look for E2E test indicators
    if find "$PROJECT_ROOT" -type f \( -name "*.e2e.*" -o -name "*e2e*test*" -o -path "*/e2e/*" -o -path "*/cypress/*" -o -path "*/playwright/*" \) 2>/dev/null | grep -q .; then
        PASSES+=("✅ E2E tests found")
    else
        VIOLATIONS+=("[MEDIUM] No E2E tests found - consider adding integration tests")
    fi
}

# Check for integration tests
check_integration_tests() {
    # Look for integration test indicators
    if find "$PROJECT_ROOT" -type f \( -name "*.integration.*" -o -name "*integration*test*" -o -path "*/integration/*" \) 2>/dev/null | grep -q .; then
        PASSES+=("✅ Integration tests found")
    else
        VIOLATIONS+=("[LOW] No integration tests found - consider adding")
    fi
}

# Run all checks
count_tests
check_journey_coverage
check_e2e_tests
check_integration_tests

# Report results
echo "| Check | Status | Details |"
echo "|-------|--------|---------|"

for pass in "${PASSES[@]}"; do
    echo "| $pass | ✅ | |"
done

for violation in "${VIOLATIONS[@]}"; do
    echo "| $violation | ❌ | Add tests |"
done

echo ""

# Exit code
if [ ${#VIOLATIONS[@]} -gt 0 ]; then
    # Check if any are CRITICAL
    critical=false
    for violation in "${VIOLATIONS[@]}"; do
        if echo "$violation" | grep -q "CRITICAL"; then
            critical=true
            break
        fi
    done

    if [ "$critical" = true ]; then
        echo "**Test Coverage: FAILED** (${#VIOLATIONS[@]} violations, including CRITICAL)"
        echo ""
        for violation in "${VIOLATIONS[@]}"; do
            echo "- $violation"
        done
        echo ""
        exit 1
    else
        echo "**Test Coverage: WARNING** (${#VIOLATIONS[@]} recommendations)"
        echo ""
        for violation in "${VIOLATIONS[@]}"; do
            echo "- $violation"
        done
        echo ""
        echo "Consider adding tests, but not blocking merge."
        echo ""
        exit 0
    fi
else
    echo "**Test Coverage: PASSED** (${#PASSES[@]} checks passed)"
    echo ""
    echo "Test coverage is adequate."
    echo ""
    exit 0
fi
