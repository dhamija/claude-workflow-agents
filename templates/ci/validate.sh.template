#!/bin/bash

# Master validation script for {{PROJECT_NAME}}
# Generated by ci-cd-engineer agent
# Validates code against /docs/intent/, /docs/ux/, /docs/architecture/

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RULES_FILE="$SCRIPT_DIR/rules.json"
REPORT_FILE="$SCRIPT_DIR/reports/latest.md"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if rules exist
if [ ! -f "$RULES_FILE" ]; then
    echo -e "${RED}âŒ ERROR: Validation rules not found${NC}"
    echo "Expected: $RULES_FILE"
    echo ""
    echo "Rules are generated from your /docs/ directory."
    echo "They should have been created during CI/CD setup."
    echo ""
    echo "To regenerate rules, ask Claude Code:"
    echo '  "Regenerate CI/CD validation rules"'
    exit 1
fi

# Create reports directory
mkdir -p "$SCRIPT_DIR/reports"

# Initialize report
cat > "$REPORT_FILE" << EOF
# Validation Report

**Date:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
**Commit:** $(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
**Trigger:** ${CI_TRIGGER:-manual}

---

EOF

# Track overall status
CRITICAL_FAILURES=0
HIGH_FAILURES=0
MEDIUM_FAILURES=0
WARNINGS=0

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ” VALIDATION SUITE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Run validators
run_validator() {
    local name=$1
    local script=$2
    local severity=${3:-CRITICAL}

    if [ ! -f "$SCRIPT_DIR/validators/$script" ]; then
        echo -e "${YELLOW}âš ï¸  SKIP: $name (validator not found)${NC}"
        return 0
    fi

    echo -e "${BLUE}Running: $name${NC}"

    if bash "$SCRIPT_DIR/validators/$script" >> "$REPORT_FILE" 2>&1; then
        echo -e "${GREEN}âœ… PASS: $name${NC}"
        return 0
    else
        case $severity in
            CRITICAL)
                echo -e "${RED}âŒ FAIL: $name (CRITICAL)${NC}"
                ((CRITICAL_FAILURES++))
                ;;
            HIGH)
                echo -e "${RED}âŒ FAIL: $name (HIGH)${NC}"
                ((HIGH_FAILURES++))
                ;;
            MEDIUM)
                echo -e "${YELLOW}âš ï¸  FAIL: $name (MEDIUM)${NC}"
                ((MEDIUM_FAILURES++))
                ;;
            *)
                echo -e "${YELLOW}âš ï¸  WARNING: $name${NC}"
                ((WARNINGS++))
                ;;
        esac
        return 1
    fi
}

# Run all validators
run_validator "Intent Validation" "intent-validator.sh" "CRITICAL"
run_validator "UX Validation" "ux-validator.sh" "HIGH"
run_validator "Architecture Validation" "arch-validator.sh" "CRITICAL"
run_validator "Test Coverage" "test-validator.sh" "HIGH"

# Generate verdict
echo "" | tee -a "$REPORT_FILE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" | tee -a "$REPORT_FILE"
echo "VERDICT" | tee -a "$REPORT_FILE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" | tee -a "$REPORT_FILE"
echo "" | tee -a "$REPORT_FILE"

if [ $CRITICAL_FAILURES -gt 0 ]; then
    echo -e "${RED}âŒ CRITICAL FAILURES: $CRITICAL_FAILURES${NC}" | tee -a "$REPORT_FILE"
    echo "" | tee -a "$REPORT_FILE"
    echo "Critical promises from /docs/intent/ are broken." | tee -a "$REPORT_FILE"
    echo "Deployment BLOCKED until fixed." | tee -a "$REPORT_FILE"
    echo "" | tee -a "$REPORT_FILE"
    exit 1
elif [ $HIGH_FAILURES -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  HIGH PRIORITY FAILURES: $HIGH_FAILURES${NC}" | tee -a "$REPORT_FILE"
    echo "" | tee -a "$REPORT_FILE"
    echo "Important requirements not met." | tee -a "$REPORT_FILE"
    echo "Review failures and fix before merging." | tee -a "$REPORT_FILE"
    echo "" | tee -a "$REPORT_FILE"
    exit 1
elif [ $MEDIUM_FAILURES -gt 0 ] || [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  WARNINGS: $MEDIUM_FAILURES medium, $WARNINGS low${NC}" | tee -a "$REPORT_FILE"
    echo "" | tee -a "$REPORT_FILE"
    echo "Minor issues found. Address when possible." | tee -a "$REPORT_FILE"
    echo "Deployment allowed." | tee -a "$REPORT_FILE"
    echo "" | tee -a "$REPORT_FILE"
    exit 0
else
    echo -e "${GREEN}âœ… ALL CLEAR${NC}" | tee -a "$REPORT_FILE"
    echo "" | tee -a "$REPORT_FILE"
    echo "All promises honored. All journeys tested." | tee -a "$REPORT_FILE"
    echo "Architecture intact. Ready to ship." | tee -a "$REPORT_FILE"
    echo "" | tee -a "$REPORT_FILE"
    exit 0
fi
