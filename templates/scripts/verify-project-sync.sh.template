#!/bin/bash
# verify-project-sync.sh
# Verifies project documentation is in sync with code reality
# Auto-generated for {{PROJECT_NAME}}

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Counters
CHECKS_PASSED=0
CHECKS_FAILED=0
WARNINGS=0

# Helper functions
pass() {
    echo -e "${GREEN}✓${NC} $1"
    ((CHECKS_PASSED++))
}

fail() {
    echo -e "${RED}✗${NC} $1"
    ((CHECKS_FAILED++))
}

warn() {
    echo -e "${YELLOW}⚠${NC} $1"
    ((WARNINGS++))
}

section() {
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "$1"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
}

# ═══════════════════════════════════════════════════════════
# CHECK 1: CLAUDE.md exists and has Current State section
# ═══════════════════════════════════════════════════════════
section "1. CLAUDE.md Current State"

if [ ! -f "CLAUDE.md" ]; then
    fail "CLAUDE.md does not exist"
else
    if grep -q "## Current State" CLAUDE.md; then
        pass "CLAUDE.md has Current State section"
    else
        fail "CLAUDE.md missing Current State section"
    fi
fi

# ═══════════════════════════════════════════════════════════
# CHECK 2: /docs/ directory structure
# ═══════════════════════════════════════════════════════════
section "2. Documentation Structure"

REQUIRED_DIRS=(
    "docs/intent"
    "docs/ux"
    "docs/architecture"
    "docs/plans"
)

for dir in "${REQUIRED_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        pass "$dir exists"
    else
        warn "$dir missing (may not be created yet)"
    fi
done

# ═══════════════════════════════════════════════════════════
# CHECK 3: Intent document has status markers
# ═══════════════════════════════════════════════════════════
section "3. Intent Status Markers"

INTENT_FILE="docs/intent/product-intent.md"
if [ -f "$INTENT_FILE" ]; then
    # Check if any promises have status markers
    if grep -q "\[KEPT\]\|\[AT RISK\]\|\[BROKEN\]" "$INTENT_FILE"; then
        pass "Intent has promise status markers"
    else
        warn "Intent has no status markers (add [KEPT], [AT RISK], [BROKEN])"
    fi
else
    warn "Intent document not found"
fi

# ═══════════════════════════════════════════════════════════
# CHECK 4: UX journeys have status markers
# ═══════════════════════════════════════════════════════════
section "4. UX Journey Status Markers"

UX_FILE="docs/ux/user-journeys.md"
if [ -f "$UX_FILE" ]; then
    # Check if any journeys have status markers
    if grep -q "\[IMPLEMENTED\]\|\[PARTIAL\]\|\[NOT STARTED\]" "$UX_FILE"; then
        pass "UX journeys have status markers"
    else
        warn "UX journeys have no status markers (add [IMPLEMENTED], [PARTIAL], [NOT STARTED])"
    fi
else
    warn "UX journeys document not found"
fi

# ═══════════════════════════════════════════════════════════
# CHECK 5: Implementation order exists
# ═══════════════════════════════════════════════════════════
section "5. Implementation Order"

IMPL_ORDER="docs/plans/implementation-order.md"
if [ -f "$IMPL_ORDER" ]; then
    pass "Implementation order document exists"

    # Check for feature status tracking
    if grep -q "| Feature | Backend | Frontend | Tests | Status |" "$IMPL_ORDER"; then
        pass "Feature tracking table exists"
    else
        warn "Feature tracking table missing"
    fi
else
    warn "Implementation order not found"
fi

# ═══════════════════════════════════════════════════════════
# CHECK 6: Test coverage tracking
# ═══════════════════════════════════════════════════════════
section "6. Test Coverage"

# Check if CLAUDE.md mentions test coverage
if [ -f "CLAUDE.md" ]; then
    if grep -q -i "test coverage\|tests:" CLAUDE.md; then
        pass "CLAUDE.md tracks test coverage"
    else
        warn "CLAUDE.md doesn't mention test coverage"
    fi
fi

# Check if test directories exist
TEST_DIRS=("tests" "test" "__tests__" "spec")
TEST_DIR_FOUND=false
for dir in "${TEST_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        TEST_DIR_FOUND=true
        pass "Test directory exists: $dir"
        break
    fi
done

if [ "$TEST_DIR_FOUND" = false ]; then
    warn "No test directory found (tests/, test/, __tests__, or spec/)"
fi

# ═══════════════════════════════════════════════════════════
# CHECK 7: Recent sync timestamp
# ═══════════════════════════════════════════════════════════
section "7. Last Sync Timestamp"

if [ -f "CLAUDE.md" ]; then
    if grep -q "Last sync:" CLAUDE.md; then
        LAST_SYNC=$(grep "Last sync:" CLAUDE.md | head -1)
        pass "Last sync recorded: $LAST_SYNC"
    else
        warn "No sync timestamp in CLAUDE.md"
    fi
fi

# ═══════════════════════════════════════════════════════════
# SUMMARY
# ═══════════════════════════════════════════════════════════
section "Verification Summary"

echo ""
echo "Checks passed:  ${GREEN}$CHECKS_PASSED${NC}"
echo "Checks failed:  ${RED}$CHECKS_FAILED${NC}"
echo "Warnings:       ${YELLOW}$WARNINGS${NC}"
echo ""

if [ $CHECKS_FAILED -gt 0 ]; then
    echo -e "${RED}╔═══════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  SYNC VERIFICATION FAILED                     ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════════════╝${NC}"
    echo ""
    echo "Run '/sync' to update project state"
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}╔═══════════════════════════════════════════════╗${NC}"
    echo -e "${YELLOW}║  SYNC VERIFICATION PASSED WITH WARNINGS       ║${NC}"
    echo -e "${YELLOW}╚═══════════════════════════════════════════════╝${NC}"
    echo ""
    echo "Consider running '/sync' to address warnings"
    exit 0
else
    echo -e "${GREEN}╔═══════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║  SYNC VERIFICATION PASSED                     ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════════════╝${NC}"
    echo ""
    echo "Project documentation is in sync ✓"
    exit 0
fi
