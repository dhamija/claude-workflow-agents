#!/bin/bash

# workflow-update - Update workflow agents to latest version
# Pulls latest changes and optionally patches project CLAUDE.md

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKFLOW_HOME="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘     WORKFLOW AGENTS UPDATE                                     â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check if workflow is installed
if [ ! -d "$WORKFLOW_HOME" ]; then
    echo -e "${RED}âœ— Workflow agents not found${NC}"
    echo ""
    echo "Expected location: $WORKFLOW_HOME"
    echo "Please install first: curl -fsSL <install-url> | bash"
    exit 1
fi

# Check if it's a git repository
cd "$WORKFLOW_HOME"
if [ ! -d ".git" ]; then
    echo -e "${RED}âœ— Not a git repository${NC}"
    echo ""
    echo "The workflow agents directory is not a git repository."
    echo "Cannot update automatically."
    exit 1
fi

# Get current version
if [ -f "version.txt" ]; then
    CURRENT_VERSION=$(cat version.txt)
else
    CURRENT_VERSION="unknown"
fi

echo "Current version: $CURRENT_VERSION"
echo "Installation: $WORKFLOW_HOME"
echo ""

# Fetch latest changes
echo -e "${BLUE}Fetching latest changes...${NC}"
git fetch origin master

# Check if updates available
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/master)

if [ "$LOCAL" = "$REMOTE" ]; then
    echo -e "${GREEN}âœ“ Already up to date${NC}"
    echo ""
    echo "No updates available."
    exit 0
fi

# Show what will be updated
echo ""
echo -e "${YELLOW}Updates available:${NC}"
echo ""
git log --oneline HEAD..origin/master | head -10
echo ""

# Ask for confirmation
read -p "Update to latest version? [Y/n]: " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]] && [[ ! -z $REPLY ]]; then
    echo -e "${YELLOW}Update cancelled${NC}"
    exit 0
fi

# Pull changes
echo ""
echo -e "${BLUE}Updating...${NC}"
git pull origin master

# Get new version
if [ -f "version.txt" ]; then
    NEW_VERSION=$(cat version.txt)
else
    NEW_VERSION="unknown"
fi

echo ""
echo -e "${GREEN}âœ“ Update complete${NC}"
echo ""
echo "  Updated: $CURRENT_VERSION â†’ $NEW_VERSION"
echo ""

# Check if symlinks need updating (in case new agents/commands were added)
echo -e "${BLUE}Checking for new agents/commands...${NC}"

# Count agents/commands
AGENT_COUNT=$(find "$WORKFLOW_HOME/agents" -name "*.md" -type f | wc -l | tr -d ' ')
COMMAND_COUNT=$(find "$WORKFLOW_HOME/commands" -name "*.md" -type f | wc -l | tr -d ' ')

# Count symlinks
if [ -d "$HOME/.claude/agents" ]; then
    AGENT_SYMLINKS=$(find "$HOME/.claude/agents" -type l -exec readlink {} \; | grep -c "$WORKFLOW_HOME/agents" || true)
else
    AGENT_SYMLINKS=0
fi

if [ -d "$HOME/.claude/commands" ]; then
    COMMAND_SYMLINKS=$(find "$HOME/.claude/commands" -type l -exec readlink {} \; | grep -c "$WORKFLOW_HOME/commands" || true)
else
    COMMAND_SYMLINKS=0
fi

# Update symlinks if counts don't match
if [ "$AGENT_COUNT" != "$AGENT_SYMLINKS" ] || [ "$COMMAND_COUNT" != "$COMMAND_SYMLINKS" ]; then
    echo -e "${YELLOW}âš  Symlinks out of sync${NC}"
    echo ""
    echo "  Agents: $AGENT_SYMLINKS/$AGENT_COUNT"
    echo "  Commands: $COMMAND_SYMLINKS/$COMMAND_COUNT"
    echo ""
    echo "Re-running symlink creation..."

    # Recreate symlinks (this logic should match install.sh)
    # Create symlinks for each agent
    for agent in "$WORKFLOW_HOME/agents"/*.md; do
        [ -f "$agent" ] || continue
        name=$(basename "$agent")
        ln -sf "$agent" "$HOME/.claude/agents/$name"
    done

    # Create symlinks for each command
    for command in "$WORKFLOW_HOME/commands"/*.md; do
        [ -f "$command" ] || continue
        name=$(basename "$command")
        ln -sf "$command" "$HOME/.claude/commands/$name"
    done

    echo -e "${GREEN}âœ“${NC} Symlinks updated"
else
    echo -e "${GREEN}âœ“${NC} Symlinks up to date"
fi

echo ""

# Offer to patch CLAUDE.md if we're in a project directory
if [ -f "$(pwd)/CLAUDE.md" ]; then
    # We're in a project directory (user ran workflow-update from project)
    if grep -q "## ğŸ”„ Workflow Active" CLAUDE.md 2>/dev/null; then
        echo ""
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${YELLOW}Project CLAUDE.md detected${NC}"
        echo ""
        echo "This directory has a workflow-enabled CLAUDE.md."
        echo "The update may include improvements to orchestration logic."
        echo ""
        echo "Would you like to patch your CLAUDE.md with the latest template?"
        echo ""
        echo "  [Y] Yes - Run workflow-patch (with diff preview)"
        echo "  [N] No  - Skip patching for now"
        echo "  [L] Learn more about patching"
        echo ""
        read -p "Choice [Y/n/l]: " -n 1 -r
        echo ""

        if [[ $REPLY =~ ^[Ll]$ ]]; then
            echo ""
            echo -e "${BLUE}About workflow-patch:${NC}"
            echo ""
            echo "The patch utility safely merges template updates into your CLAUDE.md."
            echo ""
            echo "What gets updated:"
            echo "  â€¢ Orchestration flows (L1/L2)"
            echo "  â€¢ Quality gates"
            echo "  â€¢ Issue response protocols"
            echo "  â€¢ Design principles"
            echo "  â€¢ Commands reference"
            echo ""
            echo "What gets preserved:"
            echo "  â€¢ Your project name and description"
            echo "  â€¢ Your workflow state (progress, features, promises)"
            echo "  â€¢ Your project context (decisions, notes)"
            echo ""
            echo "Safety features:"
            echo "  â€¢ Creates backup before patching"
            echo "  â€¢ Shows diff preview"
            echo "  â€¢ Requires confirmation"
            echo "  â€¢ Can be reverted"
            echo ""
            read -p "Run workflow-patch now? [Y/n]: " -n 1 -r
            echo ""
        fi

        if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
            echo ""
            exec "$WORKFLOW_HOME/bin/workflow-patch"
        else
            echo ""
            echo "Skipping patch. You can run it later with:"
            echo "  workflow-patch"
            echo ""
        fi
    fi
fi

echo ""
echo -e "${GREEN}Update complete!${NC}"
echo ""
echo "Changes installed:"
echo "  â€¢ Agents: $AGENT_COUNT"
echo "  â€¢ Commands: $COMMAND_COUNT"
echo "  â€¢ Templates: Updated"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  â€¢ Restart Claude Code to load updates"
echo "  â€¢ In projects with CLAUDE.md, run: workflow-patch"
echo ""

