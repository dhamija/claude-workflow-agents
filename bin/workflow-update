#!/bin/bash

# workflow-update - Update workflow agents to latest version
# Pulls latest changes and optionally patches project CLAUDE.md

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/config.sh"

echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘     WORKFLOW AGENTS UPDATE                                     â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check if workflow is installed
if [ ! -d "$INSTALL_DIR" ]; then
    echo -e "${RED}âœ— Workflow agents not found${NC}"
    echo ""
    echo "Expected location: $INSTALL_DIR"
    echo "Please install first: curl -fsSL <install-url> | bash"
    exit 1
fi

# Check if it's a git repository
cd "$INSTALL_DIR"
if [ ! -d ".git" ]; then
    echo -e "${RED}âœ— Not a git repository${NC}"
    echo ""
    echo "The workflow agents directory is not a git repository."
    echo "Cannot update automatically."
    exit 1
fi

# Get current version
CURRENT_VERSION=$(get_installed_version)

echo "Current version: $CURRENT_VERSION"
echo "Installation: $INSTALL_DIR"
echo ""

# Fetch latest changes
echo -e "${BLUE}Fetching latest changes...${NC}"
git fetch origin master

# Check if updates available
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/master)

if [ "$LOCAL" = "$REMOTE" ]; then
    echo -e "${GREEN}âœ“ Already up to date${NC}"
    echo ""
    echo "No updates available."
    exit 0
fi

# Show what will be updated
echo ""
echo -e "${YELLOW}Updates available:${NC}"
echo ""
git log --oneline HEAD..origin/master | head -10
echo ""

# Ask for confirmation
read -p "Update to latest version? [Y/n]: " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]] && [[ ! -z $REPLY ]]; then
    echo -e "${YELLOW}Update cancelled${NC}"
    exit 0
fi

# Pull changes
echo ""
echo -e "${BLUE}Updating...${NC}"
git pull origin master

# Get new version
NEW_VERSION=$(get_installed_version)

echo ""
echo -e "${GREEN}âœ“ Update complete${NC}"
echo ""
echo "  Updated: $CURRENT_VERSION â†’ $NEW_VERSION"
echo ""

# Re-source config to get any new values
source "$SCRIPT_DIR/../lib/config.sh"

# Check if symlinks need updating (using shared functions)
echo -e "${BLUE}Checking for new agents/commands...${NC}"

# Use shared functions for counting
AGENT_COUNT=$(find "$INSTALL_DIR/agents" -name "*.md" -type f | wc -l | tr -d ' ')
COMMAND_COUNT=$(find "$INSTALL_DIR/commands" -name "*.md" -type f | wc -l | tr -d ' ')

subagent_symlinks=$(count_subagents)
command_symlinks=$(count_commands)

# Always refresh to ensure consistency
echo "Refreshing symlinks using shared config..."
cleanup_commands "$CLAUDE_DIR"
install_commands "$INSTALL_DIR" "$CLAUDE_DIR"

cleanup_skills "$CLAUDE_DIR"
install_skills "$INSTALL_DIR" "$CLAUDE_DIR"

cleanup_agents "$CLAUDE_DIR"
install_subagents "$INSTALL_DIR" "$CLAUDE_DIR"

echo -e "${GREEN}âœ“${NC} Symlinks updated"

echo ""

# Save original directory to check for CLAUDE.md
ORIGINAL_DIR="$OLDPWD"

# Offer to patch CLAUDE.md if we're in a project directory
if [ -f "$ORIGINAL_DIR/CLAUDE.md" ]; then
    # We're in a project directory (user ran workflow-update from project)
    if grep -q -E "## ğŸ”„ (Workflow Active|WORKFLOW ACTIVE)" "$ORIGINAL_DIR/CLAUDE.md" 2>/dev/null; then
        echo ""
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${YELLOW}Project CLAUDE.md detected${NC}"
        echo ""
        echo "This directory has a workflow-enabled CLAUDE.md."
        echo "The update may include improvements to orchestration logic."
        echo ""
        echo "Would you like to patch your CLAUDE.md with the latest template?"
        echo ""
        echo "  [Y] Yes - Run workflow-patch (with diff preview)"
        echo "  [N] No  - Skip patching for now"
        echo "  [L] Learn more about patching"
        echo ""
        read -p "Choice [Y/n/l]: " -n 1 -r
        echo ""

        if [[ $REPLY =~ ^[Ll]$ ]]; then
            echo ""
            echo -e "${BLUE}About workflow-patch:${NC}"
            echo ""
            echo "The patch utility safely merges template updates into your CLAUDE.md."
            echo ""
            echo "What gets updated:"
            echo "  â€¢ Orchestration flows (L1/L2)"
            echo "  â€¢ Quality gates"
            echo "  â€¢ Issue response protocols"
            echo "  â€¢ Design principles"
            echo "  â€¢ Commands reference"
            echo ""
            echo "What gets preserved:"
            echo "  â€¢ Your project name and description"
            echo "  â€¢ Your workflow state (progress, features, promises)"
            echo "  â€¢ Your project context (decisions, notes)"
            echo ""
            echo "Safety features:"
            echo "  â€¢ Creates backup before patching"
            echo "  â€¢ Shows diff preview"
            echo "  â€¢ Requires confirmation"
            echo "  â€¢ Can be reverted"
            echo ""
            read -p "Run workflow-patch now? [Y/n]: " -n 1 -r
            echo ""
        fi

        if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
            echo ""
            cd "$ORIGINAL_DIR"
            exec "$INSTALL_DIR/bin/workflow-patch"
        else
            echo ""
            echo "Skipping patch. You can run it later with:"
            echo "  workflow-patch"
            echo ""
        fi
    fi
fi

echo ""
echo -e "${GREEN}Update complete!${NC}"
echo ""
echo "Changes installed:"
echo "  â€¢ Agents: $AGENT_COUNT"
echo "  â€¢ Commands: $COMMAND_COUNT"
echo "  â€¢ Skills: $WORKFLOW_SKILL_COUNT"
echo "  â€¢ Subagents: $CORE_SUBAGENT_COUNT (${CORE_SUBAGENTS[*]})"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  â€¢ Restart Claude Code to load updates"
echo "  â€¢ In projects with CLAUDE.md, run: workflow-patch"
echo ""
