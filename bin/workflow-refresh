#!/bin/bash

# Refresh command/skill/agent symlinks after update
# This ensures new commands and skills appear in Claude Code

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/config.sh"

echo ""
echo "Refreshing Claude Workflow Agents symlinks..."
echo ""

# Check installation
if [ ! -d "$INSTALL_DIR" ]; then
    echo "Error: Workflow not installed"
    exit 1
fi

# Ensure directories exist
mkdir -p "$CLAUDE_DIR/agents"
mkdir -p "$CLAUDE_DIR/commands"
mkdir -p "$CLAUDE_DIR/skills"

# Clean and reinstall using shared functions
echo "Cleaning old command symlinks..."
cleanup_commands "$CLAUDE_DIR"

echo "Creating command symlinks..."
install_commands "$INSTALL_DIR" "$CLAUDE_DIR"
command_count=$(count_commands)

echo "Refreshing skills..."
cleanup_skills "$CLAUDE_DIR"
install_skills "$INSTALL_DIR" "$CLAUDE_DIR"
skill_count=$(count_skills)

echo "Refreshing subagent symlinks..."
cleanup_agents "$CLAUDE_DIR"
install_subagents "$INSTALL_DIR" "$CLAUDE_DIR"
subagent_count=$(count_subagents)

echo ""
echo "âœ“ Refresh complete"
echo ""
echo "  Commands:  $command_count linked"
echo "  Skills:    $skill_count installed (expected: $WORKFLOW_SKILL_COUNT)"
echo "  Subagents: $subagent_count linked (${CORE_SUBAGENTS[*]})"
echo ""
