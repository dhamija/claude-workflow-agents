#!/bin/bash

# Install or update the Workflow Control Center UI

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/config.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
UI_BRANCH="${1:-feature/workflow-ui}"
UI_DIR="$INSTALL_DIR/ui"

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║     Workflow UI Installation                                  ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""

# Function to check Node.js installation
check_node() {
    if ! command -v node &> /dev/null; then
        echo -e "${RED}✗ Node.js is not installed${NC}"
        echo ""
        echo "Please install Node.js (v18 or higher) from:"
        echo "  ${BLUE}https://nodejs.org/${NC}"
        echo ""
        echo "Or use a package manager:"
        echo "  macOS:    ${BLUE}brew install node${NC}"
        echo "  Ubuntu:   ${BLUE}sudo apt install nodejs npm${NC}"
        echo "  Arch:     ${BLUE}sudo pacman -S nodejs npm${NC}"
        return 1
    fi

    # Check Node version
    node_version=$(node --version | cut -d'v' -f2)
    major_version=$(echo "$node_version" | cut -d'.' -f1)

    if [ "$major_version" -lt 18 ]; then
        echo -e "${YELLOW}⚠ Node.js version is too old${NC}"
        echo "  Current: v$node_version"
        echo "  Required: v18.0.0 or higher"
        echo ""
        echo "Please update Node.js"
        return 1
    fi

    echo -e "${GREEN}✓ Node.js v$node_version${NC}"
    return 0
}

# Function to check npm installation
check_npm() {
    if ! command -v npm &> /dev/null; then
        echo -e "${RED}✗ npm is not installed${NC}"
        echo ""
        echo "npm should come with Node.js. Please reinstall Node.js."
        return 1
    fi

    npm_version=$(npm --version)
    echo -e "${GREEN}✓ npm v$npm_version${NC}"
    return 0
}

# Main installation
main() {
    echo "Checking requirements..."
    echo ""

    # Check Node.js and npm
    if ! check_node; then
        exit 1
    fi

    if ! check_npm; then
        exit 1
    fi

    echo ""
    echo "Installing Workflow UI..."
    echo ""

    # Navigate to workflow directory
    cd "$INSTALL_DIR"

    # Fetch the UI branch
    echo "Fetching UI branch..."
    git fetch origin "$UI_BRANCH" 2>/dev/null || {
        echo -e "${RED}✗ Failed to fetch branch: $UI_BRANCH${NC}"
        echo ""
        echo "Available branches:"
        git branch -r | grep -E "origin/(master|main|feature/)" | sed 's/origin\//  /'
        echo ""
        echo "Usage: workflow-ui-install [branch-name]"
        exit 1
    }

    # Stash any local changes
    if [ -n "$(git status --porcelain)" ]; then
        echo "Stashing local changes..."
        git stash push -m "UI installation $(date +%Y%m%d-%H%M%S)"
    fi

    # Checkout the UI branch
    echo "Checking out $UI_BRANCH..."
    git checkout "$UI_BRANCH"

    # Check if UI directory exists
    if [ ! -d "$UI_DIR" ]; then
        echo -e "${RED}✗ UI directory not found in branch: $UI_BRANCH${NC}"
        echo ""
        echo "This branch doesn't contain the UI. Try:"
        echo "  ${BLUE}workflow-ui-install feature/workflow-ui${NC}"
        exit 1
    fi

    # Install UI dependencies
    echo ""
    echo "Installing UI dependencies..."
    cd "$UI_DIR"

    # Clean install to avoid conflicts
    if [ -d "node_modules" ]; then
        echo "Cleaning existing node_modules..."
        rm -rf node_modules package-lock.json
    fi

    echo "Installing frontend dependencies..."
    npm install --legacy-peer-deps

    # Install server dependencies
    echo ""
    echo "Installing server dependencies..."
    cd "$UI_DIR/server"

    if [ -d "node_modules" ]; then
        rm -rf node_modules package-lock.json
    fi

    npm install --legacy-peer-deps

    # Create symlinks for UI commands if not already in install.sh
    echo ""
    echo "Setting up UI commands..."

    for cmd in workflow-ui-start workflow-ui-stop workflow-ui-status workflow-ui-install; do
        if [ -f "$INSTALL_DIR/bin/$cmd" ]; then
            chmod +x "$INSTALL_DIR/bin/$cmd"
            echo -e "${GREEN}✓ $cmd${NC}"
        fi
    done

    # Success message
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo -e "${GREEN}✓ Workflow UI installed successfully!${NC}"
    echo "════════════════════════════════════════════════════════════════"
    echo ""
    echo "Available commands:"
    echo ""
    echo "  ${BLUE}workflow-ui-start${NC}   - Start the UI"
    echo "  ${BLUE}workflow-ui-status${NC}  - Check UI status"
    echo "  ${BLUE}workflow-ui-stop${NC}    - Stop the UI"
    echo ""
    echo "Quick start:"
    echo "  1. Navigate to your project: ${BLUE}cd your-project${NC}"
    echo "  2. Start the UI: ${BLUE}workflow-ui-start${NC}"
    echo "  3. Open browser: ${BLUE}http://localhost:3000${NC}"
    echo ""
    echo "The UI will automatically detect your project and display"
    echo "workflow artifacts in a visual grid interface."
    echo ""
}

# Run main function
main