#!/bin/bash

# Check status of the Workflow Control Center UI

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/config.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
UI_DIR="$INSTALL_DIR/ui"
UI_PORT="${UI_PORT:-3000}"
SERVER_PORT="${SERVER_PORT:-4000}"
UI_PID_FILE="$HOME/.claude-workflow-ui.pid"
UI_LOG_FILE="$HOME/.claude-workflow-ui.log"

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║     Workflow UI Status                                        ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""

# Function to check if a port is in use
check_port() {
    local port=$1
    if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
        return 0  # Port is in use
    else
        return 1  # Port is free
    fi
}

# Function to check service health
check_health() {
    local url=$1
    if curl -s -o /dev/null -w "%{http_code}" "$url" | grep -q "200\|304"; then
        return 0
    else
        return 1
    fi
}

# Check UI installation
echo "Installation Status:"
if [ -d "$UI_DIR" ]; then
    echo -e "  UI Directory:     ${GREEN}✓ Installed${NC}"

    # Check branch
    cd "$UI_DIR"
    current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    echo "  Current Branch:   $current_branch"

    # Check dependencies
    if [ -d "$UI_DIR/node_modules" ]; then
        echo -e "  Dependencies:     ${GREEN}✓ Installed${NC}"
    else
        echo -e "  Dependencies:     ${RED}✗ Not installed${NC}"
        echo "                    Run: cd $UI_DIR && npm install"
    fi
else
    echo -e "  UI Directory:     ${RED}✗ Not installed${NC}"
    echo ""
    echo "  To install the UI:"
    echo "    ${BLUE}workflow-update feature/workflow-ui${NC}"
fi

echo ""
echo "Service Status:"

# Check backend server
if check_port $SERVER_PORT; then
    echo -e "  Backend Server:   ${GREEN}✓ Running${NC} on port $SERVER_PORT"

    # Check health endpoint
    if check_health "http://localhost:$SERVER_PORT/api/workflow/state"; then
        echo -e "  Server Health:    ${GREEN}✓ Healthy${NC}"
    else
        echo -e "  Server Health:    ${YELLOW}⚠ Not responding${NC}"
    fi
else
    echo -e "  Backend Server:   ${RED}✗ Not running${NC}"
fi

# Check frontend
if check_port $UI_PORT; then
    echo -e "  Frontend:         ${GREEN}✓ Running${NC} on port $UI_PORT"
    echo "  URL:              ${BLUE}http://localhost:$UI_PORT${NC}"
else
    echo -e "  Frontend:         ${RED}✗ Not running${NC}"
fi

# Check Claude connection
echo ""
echo "Claude Integration:"
if [ -f "$HOME/.claude/connected" ]; then
    echo -e "  Claude Status:    ${GREEN}✓ Connected${NC}"
else
    echo -e "  Claude Status:    ${YELLOW}○ Not connected${NC}"
    echo "                    In Claude Code, run: workflow-ui-connect"
fi

# Check project context
echo ""
echo "Project Context:"
if [ -f "CLAUDE.md" ]; then
    project_name=$(basename "$PWD")
    echo -e "  Current Project:  ${GREEN}$project_name${NC}"
    echo "  Project Path:     $PWD"

    # Check for task queue
    if [ -d ".claude/tasks" ]; then
        pending_count=$(ls -1 .claude/tasks/pending 2>/dev/null | wc -l | tr -d ' ')
        progress_count=$(ls -1 .claude/tasks/progress 2>/dev/null | wc -l | tr -d ' ')
        completed_count=$(ls -1 .claude/tasks/completed 2>/dev/null | wc -l | tr -d ' ')

        echo ""
        echo "  Task Queue:"
        echo "    Pending:        $pending_count"
        echo "    In Progress:    $progress_count"
        echo "    Completed:      $completed_count"
    fi
else
    echo -e "  Current Project:  ${YELLOW}None${NC}"
    echo "                    Navigate to a project directory with CLAUDE.md"
fi

# Check logs
echo ""
echo "Logs:"
if [ -f "$UI_LOG_FILE" ]; then
    echo "  Log File:         $UI_LOG_FILE"

    # Show last few error lines if any
    errors=$(grep -i error "$UI_LOG_FILE" 2>/dev/null | tail -3 || true)
    if [ -n "$errors" ]; then
        echo ""
        echo -e "  ${YELLOW}Recent Errors:${NC}"
        echo "$errors" | while IFS= read -r line; do
            echo "    $line"
        done
    fi
else
    echo "  Log File:         Not found"
fi

# Summary and actions
echo ""
echo "════════════════════════════════════════════════════════════════"

if check_port $UI_PORT && check_port $SERVER_PORT; then
    echo -e "${GREEN}✓ Workflow UI is running${NC}"
    echo ""
    echo "  Open in browser:  ${BLUE}http://localhost:$UI_PORT${NC}"
    echo "  Stop UI:          ${BLUE}workflow-ui-stop${NC}"
else
    echo -e "${YELLOW}○ Workflow UI is not running${NC}"
    echo ""
    echo "  Start UI:         ${BLUE}workflow-ui-start${NC}"
fi

echo "════════════════════════════════════════════════════════════════"