name: Verify

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify docs in sync
        run: |
          chmod +x scripts/verify.sh
          ./scripts/verify.sh

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run tests
        run: |
          chmod +x tests/run_all_tests.sh
          ./tests/run_all_tests.sh

  install-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod -R +x scripts/ tests/

      - name: Test global install
        run: |
          $GITHUB_WORKSPACE/install.sh
          [ -d "$HOME/.claude-workflow-agents" ] || exit 1
          [ -d "$HOME/.claude-workflow-agents/agents" ] || exit 1
          [ -d "$HOME/.claude-workflow-agents/templates" ] || exit 1
          [ -d "$HOME/.claude/skills" ] || exit 1
          [ -d "$HOME/.claude/skills/workflow" ] || exit 1
          [ -d "$HOME/.claude/skills/ux-design" ] || exit 1
          [ -f "$HOME/.claude/agents/code-reviewer.md" ] || exit 1
          [ -f "$HOME/.claude/agents/debugger.md" ] || exit 1
          [ -f "$HOME/.claude/agents/ui-debugger.md" ] || exit 1
          [ -f "$HOME/.claude-workflow-agents/version.txt" ] || exit 1
          [ -f "$HOME/.claude-workflow-agents/bin/workflow-init" ] || exit 1
          [ -f "$HOME/.claude-workflow-agents/bin/workflow-update" ] || exit 1
          [ -f "$HOME/.claude-workflow-agents/bin/workflow-patch" ] || exit 1
          echo "Global install: OK"

      - name: Test workflow-init in greenfield project
        run: |
          cd /tmp
          mkdir test-greenfield
          cd test-greenfield
          echo "y" | $HOME/.claude-workflow-agents/bin/workflow-init
          [ -f "CLAUDE.md" ] || exit 1
          grep -q "ðŸ”„ Workflow Active" CLAUDE.md || exit 1
          grep -q "type: greenfield" CLAUDE.md || exit 1
          echo "Greenfield init: OK"

      - name: Test workflow-init in brownfield project
        run: |
          cd /tmp
          mkdir test-brownfield
          cd test-brownfield
          mkdir src
          echo '{"name": "test"}' > package.json
          touch main.js
          echo "y" | $HOME/.claude-workflow-agents/bin/workflow-init
          [ -f "CLAUDE.md" ] || exit 1
          grep -q "ðŸ”„ Workflow Active" CLAUDE.md || exit 1
          grep -q "type: brownfield" CLAUDE.md || exit 1
          echo "Brownfield init: OK"

      - name: Test workflow-init preserves existing content
        run: |
          cd /tmp
          mkdir test-existing
          cd test-existing
          echo "# My Project" > CLAUDE.md
          echo "" >> CLAUDE.md
          echo "My custom content here." >> CLAUDE.md
          mkdir src
          touch package.json
          echo "y" | $HOME/.claude-workflow-agents/bin/workflow-init
          grep -q "ðŸ”„ Workflow Active" CLAUDE.md || exit 1
          grep -q "My custom content here" CLAUDE.md || exit 1
          echo "Content preservation: OK"
