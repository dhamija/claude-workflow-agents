#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PRE-COMMIT HOOK: Enforces self-maintenance rules
#
# This hook BLOCKS commits that don't follow maintenance rules.
# To bypass (emergency only): git commit --no-verify
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check if any agents/ or commands/ files changed
AGENTS_CHANGED=$(echo "$STAGED_FILES" | grep '^agents/.*\.md$' || true)
COMMANDS_CHANGED=$(echo "$STAGED_FILES" | grep '^commands/.*\.md$' || true)

# If no workflow files changed, allow commit
if [ -z "$AGENTS_CHANGED" ] && [ -z "$COMMANDS_CHANGED" ]; then
    exit 0
fi

echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${YELLOW}ğŸ”§ MAINTENANCE CHECK: Workflow files changed${NC}"
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

if [ -n "$AGENTS_CHANGED" ]; then
    echo -e "${YELLOW}Agents changed:${NC}"
    echo "$AGENTS_CHANGED" | sed 's/^/  - /'
fi

if [ -n "$COMMANDS_CHANGED" ]; then
    echo -e "${YELLOW}Commands changed:${NC}"
    echo "$COMMANDS_CHANGED" | sed 's/^/  - /'
fi

echo ""

# Required files that must be updated
REQUIRED_FILES=(
    "CLAUDE.md"
    "commands/agent-wf-help.md"
    "README.md"
    "GUIDE.md"
)

if [ -n "$AGENTS_CHANGED" ]; then
    REQUIRED_FILES+=("tests/structural/test_agents_exist.sh")
fi

if [ -n "$COMMANDS_CHANGED" ]; then
    REQUIRED_FILES+=("tests/structural/test_commands_exist.sh")
fi

# Check which required files are staged
MISSING_FILES=()
for file in "${REQUIRED_FILES[@]}"; do
    if ! echo "$STAGED_FILES" | grep -q "^$file$"; then
        MISSING_FILES+=("$file")
    fi
done

# If any required files are missing, block commit
if [ ${#MISSING_FILES[@]} -gt 0 ]; then
    echo -e "${RED}âŒ COMMIT BLOCKED${NC}"
    echo ""
    echo -e "${RED}You changed agents or commands but didn't update these required files:${NC}"
    for file in "${MISSING_FILES[@]}"; do
        echo -e "${RED}  â–¡ $file${NC}"
    done
    echo ""
    echo -e "${YELLOW}Required updates when changing workflow files:${NC}"
    echo ""
    echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${YELLOW}â”‚ You Changed       â†’ You MUST Also Update              â”‚${NC}"
    echo -e "${YELLOW}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
    echo -e "${YELLOW}â”‚ agents/*.md       â†’ CLAUDE.md (counts, list)           â”‚${NC}"
    echo -e "${YELLOW}â”‚                   â†’ commands/agent-wf-help.md          â”‚${NC}"
    echo -e "${YELLOW}â”‚                   â†’ README.md (table)                  â”‚${NC}"
    echo -e "${YELLOW}â”‚                   â†’ GUIDE.md (list)                    â”‚${NC}"
    echo -e "${YELLOW}â”‚                   â†’ tests/../test_agents_exist.sh      â”‚${NC}"
    echo -e "${YELLOW}â”‚                                                        â”‚${NC}"
    echo -e "${YELLOW}â”‚ commands/*.md     â†’ CLAUDE.md (counts, list)           â”‚${NC}"
    echo -e "${YELLOW}â”‚                   â†’ commands/agent-wf-help.md          â”‚${NC}"
    echo -e "${YELLOW}â”‚                   â†’ README.md (table)                  â”‚${NC}"
    echo -e "${YELLOW}â”‚                   â†’ GUIDE.md (list)                    â”‚${NC}"
    echo -e "${YELLOW}â”‚                   â†’ tests/../test_commands_exist.sh    â”‚${NC}"
    echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo ""
    echo -e "${YELLOW}To fix:${NC}"
    echo -e "  1. Update the missing files listed above"
    echo -e "  2. Stage them: ${GREEN}git add <files>${NC}"
    echo -e "  3. Try committing again"
    echo ""
    echo -e "${YELLOW}Helper commands:${NC}"
    echo -e "  ${GREEN}./scripts/verify-sync.sh${NC}     - Check what's out of sync"
    echo -e "  ${GREEN}./scripts/update-claude-md.sh${NC} - Update counts in CLAUDE.md"
    echo ""
    echo -e "${RED}Emergency bypass (use only if absolutely necessary):${NC}"
    echo -e "  ${RED}git commit --no-verify${NC}"
    echo ""
    exit 1
fi

# All required files are staged, run verification script
echo -e "${GREEN}âœ“ Required files are staged${NC}"
echo ""
echo -e "${YELLOW}Running verification checks...${NC}"

# Run verify-sync.sh with --quiet flag (if it supports it)
if [ -x "$REPO_ROOT/scripts/verify-sync.sh" ]; then
    if "$REPO_ROOT/scripts/verify-sync.sh" --quiet 2>/dev/null; then
        echo -e "${GREEN}âœ“ Verification passed${NC}"
        echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        exit 0
    else
        # If --quiet not supported yet, run without it
        if "$REPO_ROOT/scripts/verify-sync.sh"; then
            echo -e "${GREEN}âœ“ Verification passed${NC}"
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            exit 0
        else
            echo -e "${RED}âŒ Verification failed${NC}"
            echo -e "${RED}Fix the issues above and try again${NC}"
            exit 1
        fi
    fi
else
    echo -e "${YELLOW}âš ï¸  Warning: verify-sync.sh not found or not executable${NC}"
    echo -e "${GREEN}Proceeding with commit (required files are staged)${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 0
fi
